<a title="Ajouter du contenu" href="jsp/site/plugins/myportal/AddWidget.jsp" class="ceebox">
    <img src="images/skin/plugins/myportal/add_widget.png" alt="Add content button" /> Ajouter du contenu
</a>
<span id="addTab">
    <img src="images/skin/plugins/myportal/add_widget.png" alt="" /> Ajouter un onglet
</span>
<a href="jsp/site/Portal.jsp?page=myportal" id="addTabValid"></a>

<br />

<div id="tabs">
    ${widgets}
    <div style="clear:both"></div>
</div>
<div id="dialogCreateTab" title="Créer un onglet">
	<form name="createtab">
		<input type="text" name="tabname" value="" />
	</form>
</div>

<script type='text/javascript' src="js/plugins/myportal/jquery-ui-1.8.10.custom.min.js"></script>
<script type='text/javascript' src='js/plugins/myportal/jquery.swfobject.js' ></script>
<script type='text/javascript' src='js/plugins/myportal/jquery.metadata.js'></script>
<script type='text/javascript' src='js/plugins/myportal/jquery.color.js'></script>
<script type='text/javascript' src="js/plugins/myportal/jquery.ceebox-min.js"></script>

<script>
    $(function() {
        $( "#tabs" ).tabs().find(">.ui-tabs-nav").sortable({ axis: "x", items: "li:gt(0)" });;

        $( ".myportal-column" ).sortable({
            connectWith: ".myportal-column"
        });

        $( ".myportal-portlet" ).addClass( "ui-widget ui-widget-content ui-helper-clearfix ui-corner-all" )
        .find( ".myportal-portlet-header" )
        .addClass( "ui-widget-header ui-corner-all" )
        .prepend( "<span class='ui-icon ui-icon-circle-triangle-n icon-collapse'></span>")
        .prepend( "<span class='ui-icon ui-icon-circle-close icon-close'></span>")
        .end()
        .find( ".myportal-portlet-content" );

        $( ".myportal-portlet-fixed" ).addClass( "ui-widget ui-widget-content ui-helper-clearfix ui-corner-all" )
        .find( ".myportal-portlet-header" )
        .addClass( "ui-widget-header ui-corner-all" )
        .end()
        .find( ".myportal-portlet-content" );

        $( ".myportal-portlet-fixed" ).sortable({ disabled: true });

        $( ".myportal-portlet-header .icon-collapse" ).click(function() {
            $( this ).toggleClass( "ui-icon-circle-triangle-n" ).toggleClass( "ui-icon-circle-triangle-s" );
            $( this ).parents( ".myportal-portlet:first" ).find( ".myportal-portlet-content" ).toggle();
        });

        $( ".myportal-portlet-header .icon-close" ).click(function() {
             var id = $( this ).parents( ".myportal-portlet:first" ).attr('id');
             $.ajax({ type: "POST", url: "jsp/site/plugins/myportal/DoRemoveWidget.jsp", data: "widget=" + id });
             $( this ).parents( ".myportal-portlet:first" ).hide();
        });

        $( ".myportal-column" ).disableSelection();

        // Ceebox init
        jQuery(document).ready(function(){
                $(".ceebox").ceebox({titles:false, borderColor:'#dcdcdc',boxColor:"#fff"});
        });

    });

    /**
     * dialog box to create a tab
     */
     $( "#dialogCreateTab" ).dialog({
 	    autoOpen: false,
 	    modal: true,
 	    buttons: {
 	       "Enregistrer": function() {
 	    	  saveCurrentConfPlusTab( document.forms.createtab.tabname.value );
 	    	  location.reload();
 	       }
 	    }
     });
     
    /**
     * Save myportal state on every drap&drop
     */
	function saveCurrentConfPlusTab( tabNameToAdd ) {
		var strJson = '{"page":{"name":"Ma page","tabs":[';
    	$( "#tabs>ul>li" ).each( function( tabIndex ) {
    		var tabId = $( this ).children("a").attr( "href" );
    		var tabName = $( this ).children( "a" ).html(  );
    		strJson += '{"name": "' + tabName + '","widgets":[';
        	$( tabId ).children( ".myportal-column, .myportal-column-fixed" ).each( function( columnPos ) {
	    		columnPos++;
		    	$( this ).children( ".myportal-portlet, .myportal-portlet-fixed").each( function( portletPos ) {
		    		strJson += '{"id":' + $(this).attr("id").substring(7) + ', "state":0,"column":' + columnPos + '},';
		    	});
	    	});
    		strJson += ']},';
    	});
    	var boolAsync = true;
    	if( tabNameToAdd != null ) {
    		strJson +=  '{"name":"' + tabNameToAdd + '", "widgets":[]}';
    		boolAsync = false; //need to freeze the page to avoid the refresh to be done before Ajax call
    	}
    	strJson += ']}}';
        $.ajax({ type: "POST", async:boolAsync, url: "jsp/site/plugins/myportal/DoSavePortalState.jsp", data: "portalState=" + strJson });
    }
    
    $( "#tabs" ).bind( "sortstop", function(  ) {
		saveCurrentConfPlusTab( null );
    });
    $( "#addTab" ).click( function(  ) {
    	$( "#dialogCreateTab" ).dialog( "open" );
    });
</script>

